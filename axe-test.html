<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UUStreak Accessibility Tester (Proxy Enabled)</title>

  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; max-width: 900px; margin: 0 auto; }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      margin: -1px;
      padding: 0;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    input[type="text"] { width: 100%; padding: 0.5rem; margin-top: .3rem; }
    button { padding: .5rem 1rem; margin-right: .5rem; background: black; color: white; border: none; cursor: pointer; }
    button:hover { background: #333; }
    button:focus { outline: 2px solid #0066cc; outline-offset: 2px; }
    iframe { width: 100%; min-height: 420px; border: 1px solid #ccc; margin-top: 1rem; }
    pre { background: #f6f6f6; padding: 1rem; border-radius: 6px; max-height: 600px; overflow: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>UUStreak axe-core tester (with free proxy crawler)</h1>
    </header>
    <section aria-labelledby="test-section-heading">
      <h2 id="test-section-heading" class="visually-hidden">Test Configuration</h2>
      <label for="urlInput">URL to test:</label>
      <input id="urlInput" type="text" placeholder="https://example.com" value="https://uustreak.no/">

      <div style="margin-top: 1rem;">
        <button onclick="loadAndTest('direct')">Load & test (direct)</button>
        <button onclick="loadAndTest('allorigins')">Load via Proxy (AllOrigins)</button>
        <button onclick="loadAndTest('corsanywhere')">Load via CORS Anywhere</button>
        <button onclick="clearResults()">Clear</button>
      </div>

      <p><strong>Tip:</strong> For CORS Anywhere, open once:  
      <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">https://cors-anywhere.herokuapp.com/corsdemo</a></p>

      <iframe id="testFrame" title="Page being tested for accessibility"></iframe>
    </section>
    <section aria-labelledby="results-heading">
      <h2 id="results-heading">Results</h2>
      <pre id="results">Waiting for a test...</pre>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axe-core/4.8.4/axe.min.js"></script>

  <script>
    const iframe = document.getElementById("testFrame");
    const resultsEl = document.getElementById("results");

    function escapeHtml(str) {
      return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    async function fetchViaProxy(url, mode) {
      if (mode === "allorigins") {
        // Fully free, works in browser, supports HTTPS
        const api = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        const res = await fetch(api);
        if (!res.ok) throw new Error("AllOrigins error");
        return await res.text();
      }

      if (mode === "corsanywhere") {
        // Requires a one-time enable click — still free
        const api = `https://cors-anywhere.herokuapp.com/${url}`;
        const res = await fetch(api);
        if (!res.ok) throw new Error("CORS Anywhere error");
        return await res.text();
      }

      throw new Error("Unknown proxy mode");
    }

    async function loadAndTest(mode) {
      const url = document.getElementById("urlInput").value.trim();
      resultsEl.textContent = "Loading...";

      try {
        let html = "";

        if (mode === "direct") {
          iframe.src = url;
          await new Promise(resolve => iframe.onload = resolve);
          return runAxe(iframe.contentDocument, url);
        }

        // PROXY MODE → fetch HTML and inject into sandboxed iframe
        html = await fetchViaProxy(url, mode);

        const proxiedHTML = `
          ${html}
          <script src="https://cdnjs.cloudflare.com/ajax/libs/axe-core/4.8.4/axe.min.js"><\/script>
        `;

        iframe.srcdoc = proxiedHTML;

        await new Promise(resolve => setTimeout(resolve, 500)); // allow DOM to build

        runAxe(iframe.contentDocument, url);

      } catch (err) {
        resultsEl.textContent = "ERROR: " + err.message;
      }
    }

    async function runAxe(doc, url) {
      try {
        const results = await axe.run(doc);
        let out = `AXE Accessibility Report\nURL: ${url}\nDate: ${new Date().toLocaleString()}\n\n`;

        out += `Violations: ${results.violations.length}\n\n`;

        results.violations.forEach(v => {
          out += `---\n${v.id} (${v.impact})\n${v.help}\n${v.helpUrl}\n\n`;
          v.nodes.forEach(n => {
            out += `Element: ${n.target.join(" ")}\n\nHTML:\n${escapeHtml(n.html || "")}\n\n`;
          });
        });

        resultsEl.textContent = out;
      } catch (err) {
        resultsEl.textContent = "AXE Error: " + err.message;
      }
    }

    function clearResults() {
      iframe.src = "about:blank";
      resultsEl.textContent = "Waiting for a test...";
    }
  </script>
</body>
</html>